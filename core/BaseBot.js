const DataManager = require('./DataManager');
const ContextManager = require('./ContextManager');

class BaseBot {
  constructor(businessConfig) {
    this.config = businessConfig;
    this.dataManager = new DataManager();
    this.contextManager = new ContextManager();
    this.initialized = false;
    
    console.log(`ü§ñ Inicializando bot para: ${businessConfig.name}`);
  }

  async initialize() {
    if (this.initialized) return;
    
    try {
      await this.dataManager.initialize();
      this.initialized = true;
      console.log(`‚úÖ Bot ${this.config.name} inicializado correctamente`);
    } catch (error) {
      console.error(`‚ùå Error inicializando bot ${this.config.name}:`, error);
      throw error;
    }
  }

  async processMessage(userId, message) {
    if (!this.initialized) {
      await this.initialize();
    }

    console.log(`üí¨ Procesando mensaje de ${userId}: "${message}"`);
    
    const context = this.contextManager.getContext(userId);
    
    try {
      // 1. Detectar intenci√≥n (por ahora con l√≥gica simple)
      const intent = this.detectIntent(message, context);
      
      // 2. Procesar seg√∫n la intenci√≥n
      const response = await this.handleIntent(intent, message, context);
      
      // 3. Actualizar contexto e historial
      this.contextManager.addToHistory(userId, message, response);
      this.contextManager.updateContext(userId, {
        currentIntent: intent,
        lastMessage: message,
        lastResponse: response
      });

      console.log(`‚úÖ Respuesta generada: ${response.substring(0, 100)}...`);
      
      return response;
      
    } catch (error) {
      console.error('Error procesando mensaje:', error);
      return this.getFallbackResponse(message, context);
    }
  }

  detectIntent(message, context) {
    const msg = message.toLowerCase().trim();
    
    // Detecci√≥n b√°sica de intenciones (en Fase 2 ser√° con IA)
    if (this.isGreeting(msg)) return 'greeting';
    if (this.isAboutProducts(msg)) return 'product_inquiry';
    if (this.isAboutPrices(msg)) return 'price_inquiry';
    if (this.isAboutStock(msg)) return 'stock_inquiry';
    if (this.isAboutLocation(msg)) return 'location_inquiry';
    if (this.isAboutHours(msg)) return 'hours_inquiry';
    if (this.isAboutInsurance(msg)) return 'insurance_inquiry';
    if (this.isEmergency(msg)) return 'emergency';
    if (this.isFarewell(msg)) return 'farewell';
    
    return 'unknown';
  }

  async handleIntent(intent, message, context) {
    console.log(`üéØ Intenci√≥n detectada: ${intent}`);
    
    switch (intent) {
      case 'greeting':
        return this.handleGreeting(context);
      
      case 'product_inquiry':
        return await this.handleProductInquiry(message, context);
      
      case 'price_inquiry':
        return await this.handlePriceInquiry(message, context);
      
      case 'stock_inquiry':
        return await this.handleStockInquiry(message, context);
      
      case 'location_inquiry':
        return this.handleLocationInquiry(context);
      
      case 'hours_inquiry':
        return this.handleHoursInquiry(context);
      
      case 'insurance_inquiry':
        return this.handleInsuranceInquiry(context);
      
      case 'emergency':
        return this.handleEmergency(context);
      
      case 'farewell':
        return this.handleFarewell(context);
      
      default:
        return this.handleUnknown(message, context);
    }
  }

  // ===== MANEJADORES DE INTENCIONES =====
  
  async handleProductInquiry(message, context) {
    const products = await this.dataManager.searchProducts(message);
    
    if (products.length === 0) {
      return `üîç No encontr√© productos que coincidan con "${message}". ¬øPod√©s ser m√°s espec√≠fico? Por ejemplo: "lentes de contacto", "armazones Ray-Ban", etc.`;
    }
    
    const limitedProducts = products.slice(0, 5); // Mostrar m√°ximo 5
    
    let response = `üîç Encontr√© ${products.length} productos relacionados:\n\n`;
    
    limitedProducts.forEach((product, index) => {
      response += `${index + 1}. ${product.brand ? product.brand + ' - ' : ''}${product.name}\n`;
      response += `   üí∞ $${product.price} | üì¶ Stock: ${product.stock}\n`;
      if (product.tipo) response += `   üìù Tipo: ${product.tipo}\n`;
      response += `\n`;
    });
    
    if (products.length > 5) {
      response += `\n... y ${products.length - 5} productos m√°s. ¬øBusc√°s algo espec√≠fico?`;
    } else {
      response += `¬øTe interesa alguno de estos productos?`;
    }
    
    return response;
  }

  async handlePriceInquiry(message, context) {
    // Obtener productos y mostrar rangos de precios
    const armazones = await this.dataManager.getProducts('armazones', { inStock: true });
    const lentesContacto = await this.dataManager.getProducts('lentes_contacto', { inStock: true });
    
    const precioMinArmazones = Math.min(...armazones.map(p => p.price).filter(p => p > 0));
    const precioMaxArmazones = Math.max(...armazones.map(p => p.price));
    
    const precioMinLC = Math.min(...lentesContacto.map(p => p.price).filter(p => p > 0));
    const precioMaxLC = Math.max(...lentesContacto.map(p => p.price));
    
    return `üí∞ **Rangos de precios:**\n\n` +
           `üëì **Armazones:** $${precioMinArmazones} - $${precioMaxArmazones}\n` +
           `üëÅÔ∏è **Lentes de contacto:** $${precioMinLC} - $${precioMaxLC}\n\n` +
           `üí° *Los precios var√≠an seg√∫n marca, modelo y caracter√≠sticas.*\n` +
           `¬øTe interesa alg√∫n producto en particular?`;
  }

  async handleStockInquiry(message, context) {
    const products = await this.dataManager.searchProducts(message);
    const inStockProducts = products.filter(p => p.stock > 0);
    const outOfStockProducts = products.filter(p => p.stock === 0);
    
    if (inStockProducts.length === 0) {
      return `‚ùå No tenemos stock de productos que coincidan con "${message}".\n\n` +
             `¬øQuer√©s que te avise cuando llegue stock o prefer√≠s ver otras opciones?`;
    }
    
    let response = `‚úÖ **Productos disponibles:**\n\n`;
    
    inStockProducts.slice(0, 3).forEach((product, index) => {
      response += `${index + 1}. ${product.brand ? product.brand + ' - ' : ''}${product.name}\n`;
      response += `   üì¶ Stock: ${product.stock} | üí∞ $${product.price}\n\n`;
    });
    
    if (outOfStockProducts.length > 0) {
      response += `‚ö†Ô∏è *${outOfStockProducts.length} productos relacionados est√°n sin stock temporalmente.*\n\n`;
    }
    
    response += `¬øTe interesa alguno de estos productos?`;
    
    return response;
  }

  handleGreeting(context) {
    const templates = [
      `¬°Hola! Soy ${this.config.personality.name}, ${this.config.personality.expertise}. ¬øEn qu√© puedo ayudarte hoy?`,
      `¬°Hola! Soy ${this.config.personality.name}. ¬øNecesit√°s informaci√≥n sobre armazones, lentes de contacto o quer√©s conocer nuestros horarios?`,
      `¬°Bienvenido! Soy ${this.config.personality.name}. Contame, ¬øqu√© te gustar√≠a saber? Pod√©s preguntarme por precios, stock, horarios o direcci√≥n.`
    ];
    
    return templates[Math.floor(Math.random() * templates.length)];
  }

  handleLocationInquiry(context) {
    return `üìç **Estamos en:**\n\n` +
           `Serrano 684, Villa Crespo, CABA\n` +
           `üöá A 4 cuadras del subte √Ångel Gallardo (L√≠nea B)\n\n` +
           `¬øQuer√©s que te comparta la ubicaci√≥n en Google Maps?`;
  }

  handleHoursInquiry(context) {
    return `‚è∞ **Nuestros horarios:**\n\n` +
           `Lunes a S√°bado: 10:30 - 19:30\n` +
           `Domingos: Cerrado\n\n` +
           `¬øTe sirve alg√∫n d√≠a en particular?`;
  }

  handleInsuranceInquiry(context) {
    return `üè• **Obras sociales que aceptamos:**\n\n` +
           `‚Ä¢ Medicus\n` +
           `‚Ä¢ Osetya\n` +
           `‚Ä¢ Construir Salud\n` +
           `‚Ä¢ Swiss Medical\n\n` +
           `¬øTen√©s alguna obra social en particular?`;
  }

  handleEmergency(context) {
    return `ü©∫ **Por tu seguridad:**\n\n` +
           `Recomiendo que contactes urgentemente con un especialista.\n\n` +
           `¬øNecesit√°s que te derive con nuestro profesional o prefer√≠s que te pasemos los contactos de emergencia?`;
  }

  handleFarewell(context) {
    const farewells = [
      "¬°Gracias por contactarte! Cualquier cosa, estoy ac√° para ayudarte. üëã",
      "¬°Nos vemos! Record√° que estamos en Serrano 684 para lo que necesites. üòä",
      "¬°Que tengas un excelente d√≠a! Cualquier consulta, volv√© a escribirme. üëç"
    ];
    
    return farewells[Math.floor(Math.random() * farewells.length)];
  }

  handleUnknown(message, context) {
    return `ü§î No estoy segura de entender "${message}".\n\n` +
           `Pod√©s preguntarme por:\n` +
           `‚Ä¢ üëì Armazones y modelos\n` +
           `‚Ä¢ üëÅÔ∏è Lentes de contacto\n` +
           `‚Ä¢ üí∞ Precios y promociones\n` +
           `‚Ä¢ üì¶ Stock disponible\n` +
           `‚Ä¢ üè• Obras sociales\n` +
           `‚Ä¢ ‚è∞ Horarios de atenci√≥n\n` +
           `‚Ä¢ üìç Direcci√≥n y c√≥mo llegar`;
  }

  getFallbackResponse(message, context) {
    return `‚ö†Ô∏è Estoy teniendo dificultades t√©cnicas. Por favor, intent√° nuevamente en unos momentos.\n\n` +
           `Mientras tanto, pod√©s contactarnos al 1132774631 o visitarnos en Serrano 684.`;
  }

  // ===== DETECTORES DE INTENCI√ìN =====
  
  isGreeting(message) {
    const greetings = ['hola', 'buenas', 'buen d√≠a', 'buenas tardes', 'hello', 'hi', 'qu√© tal', 'c√≥mo and√°s'];
    return greetings.some(greet => message.includes(greet));
  }

  isAboutProducts(message) {
    const keywords = ['lente', 'armazon', 'contacto', 'lentilla', 'modelo', 'marca', 'producto', 'anteojo', 'gafa'];
    return keywords.some(keyword => message.includes(keyword));
  }

  isAboutPrices(message) {
    const keywords = ['precio', 'cuesta', 'valor', 'cuanto', 'cu√°nto', '$', 'pesos'];
    return keywords.some(keyword => message.includes(keyword));
  }

  isAboutStock(message) {
    const keywords = ['stock', 'disponible', 'queda', 'tienen'];
    return keywords.some(keyword => message.includes(keyword));
  }

  isAboutLocation(message) {
    const keywords = ['direccion', 'ubicacion', 'd√≥nde', 'donde', 'local', 'mapa', 'google maps'];
    return keywords.some(keyword => message.includes(keyword));
  }

  isAboutHours(message) {
    const keywords = ['horario', 'hora', 'abren', 'cierran', 'atenci√≥n', 'cuando'];
    return keywords.some(keyword => message.includes(keyword));
  }

  isAboutInsurance(message) {
    const keywords = ['obra social', 'prepaga', 'cobertura', 'medicus', 'osetya', 'swiss', 'construir'];
    return keywords.some(keyword => message.includes(keyword));
  }

  isEmergency(message) {
    const keywords = ['dolor', 'duele', 'molestia', 'urgencia', 'emergencia', 'no veo', 'veo mal'];
    return keywords.some(keyword => message.includes(keyword));
  }

  isFarewell(message) {
    const keywords = ['chau', 'gracias', 'adi√≥s', 'bye', 'nos vemos', 'hasta luego'];
    return keywords.some(keyword => message.includes(keyword));
  }
}

module.exports = BaseBot;
